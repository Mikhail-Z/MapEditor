{% extends 'base.html' %}
{% load static %}

{% block 'css' %}
<link rel="stylesheet" href="{% static 'css/ol.css' %}">
<link rel="stylesheet" href="{% static 'css/edit_shapefile.css' %}">
{% endblock %}

{% block 'content' %}
<div class="container text-center">
    <h3>Выберите геообъект для правки</h3>
    <div id="map" class="map"></div>
</div>
{% endblock %}

{% block 'js' %}
<script src="{% static 'js/ol.js' %}"></script>
<script src="../static/jquery.js"></script>
<script>
  function init() {
    var url_template = '{{tms_url}}/1.0/{{shapefile.id}}/{z}/{x}/{y}.png'
    var projection = 'EPSG:4326'
    var source = new ol.source.XYZ({
        crossOrigin: 'null',
        wrapX: false,
        projection: projection,
        tileUrlFunction: function(tileCoord) {
            var z = tileCoord[0] - 1;
            var x = tileCoord[1];
            var y = Math.pow(2, z) + tileCoord[2];
            return url_template
                .replace('{z}', z.toString())
                .replace('{x}', x.toString())
                .replace('{y}', y.toString());
        },
    });
    var layer = new ol.layer.Tile({source: source, projection: projection});
    var view = new ol.View({center: [0, 0], zoom: 2, projection: projection});
    var map = new ol.Map({target: 'map', layers: [layer], view: view});

    map.on('singleclick', function(e) {
        var request = $.ajax({
            url: "/find_feature",
            data: {
                shapefile_id: {{shapefile.id}},
                latitude: e.coordinate[1],
                longitude: e.coordinate[0]
            },
            success: function(response) {
                console.log(window.location.href)
                console.log(response)
                if (response != "") {
                    window.location.href = response
                }
            }
        })
    });

    map.on('click', function(e) {
        alert("click")
        var request = $.ajax({
            url: "/show_feature_info/" + {{shapefile.id}},
            data: {
                latitude: e.coordinate[1],
                longitude: e.coordinate[0]
            },
            success: function(response) {
                alert(response)
                console.log(window.location.href)
                console.log(response)
                if (response != "") {
                    window.location.href = response
                }
            }
        })
    });
  }

  $(window).on("load", init)
</script>
{% endblock %}